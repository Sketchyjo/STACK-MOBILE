# Story 3.3: Invest in a Basket ("Power Up")

## Status

Draft

## Story

**As a** user,
**I want** a simple, fast way to invest a specific amount of money into a "Basket,"
**so that** the process feels effortless and encouraging.

## Acceptance Criteria

1. On the "Basket Detail View," the user can tap the "Power Up" button.
2. A simple modal or screen appears allowing the user to input a dollar amount (minimum $1).
3. Upon confirmation, the backend processes the investment, triggering the necessary smart contract interaction via the Thirdweb SDK.
4. The user's portfolio is updated to reflect their new fractional ownership of the "Basket".
5. The user receives a clear, immediate confirmation message upon a successful transaction.

## Tasks / Subtasks

- [ ] Create Investment Modal/Screen (AC: 1, 2)
  - [ ] Create `PowerUpModal` component with proper modal styling
  - [ ] Implement dollar amount input field with validation
  - [ ] Add minimum $1 validation with clear error messaging
  - [ ] Create investment amount selection buttons (quick amounts)
  - [ ] Add confirmation button with loading states
  - [ ] Implement modal dismiss functionality

- [ ] Input Validation & UX (AC: 2)
  - [ ] Implement real-time input validation
  - [ ] Add currency formatting for input display
  - [ ] Create balance checking (sufficient funds validation)
  - [ ] Add investment amount suggestions/presets
  - [ ] Implement keyboard-friendly number input
  - [ ] Add clear error states and messaging

- [ ] Backend Investment Processing (AC: 3, 4)
  - [ ] Create investment API endpoint
  - [ ] Implement Thirdweb SDK smart contract interaction
  - [ ] Add transaction processing logic
  - [ ] Implement portfolio update mechanism
  - [ ] Add transaction history recording
  - [ ] Handle blockchain transaction confirmations

- [ ] Portfolio Integration (AC: 4)
  - [ ] Update user's portfolio holdings in real-time
  - [ ] Create new PortfolioHolding record
  - [ ] Update existing holdings if basket already owned
  - [ ] Refresh portfolio data across app
  - [ ] Handle fractional ownership calculations

- [ ] Transaction Confirmation (AC: 5)
  - [ ] Create success confirmation modal/screen
  - [ ] Display investment amount and basket details
  - [ ] Show transaction ID and timestamp
  - [ ] Add celebration animation/visual feedback
  - [ ] Provide navigation to portfolio view
  - [ ] Add sharing functionality for successful investment

- [ ] Error Handling & Edge Cases
  - [ ] Handle insufficient funds scenarios
  - [ ] Manage network connectivity issues
  - [ ] Handle smart contract transaction failures
  - [ ] Add retry mechanisms for failed transactions
  - [ ] Implement transaction timeout handling
  - [ ] Create comprehensive error messaging

- [ ] State Management (AC: 3, 4, 5)
  - [ ] Extend Zustand store for investment flow
  - [ ] Add transaction status tracking
  - [ ] Implement optimistic UI updates
  - [ ] Handle loading states throughout flow
  - [ ] Add transaction history state management

- [ ] Security & Validation
  - [ ] Implement server-side amount validation
  - [ ] Add rate limiting for investment requests
  - [ ] Validate user authentication for transactions
  - [ ] Implement transaction signing security
  - [ ] Add fraud detection mechanisms

- [ ] Testing Implementation
  - [ ] Write unit tests for PowerUpModal component
  - [ ] Write integration tests for investment flow
  - [ ] Write API endpoint tests
  - [ ] Write smart contract interaction tests
  - [ ] Write portfolio update tests
  - [ ] Write error handling tests

## Dev Notes

### Previous Story Context

From Stories 3.1 and 3.2:
- Basket list and detail views established
- Navigation flow from basket detail to investment
- API integration patterns established
- Design system integration patterns

### Data Models

**Investment Transaction Structure** [Source: architecture/data-models.md]:
```typescript
model Transaction {
  id              String            @id @default(cuid())
  amount          Decimal
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  description     String?
  user            User              @relation(fields: [userId], references: [id])
  userId          String
  basketId        String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  blockchainTxId  String?
  fees            Decimal?
}

enum TransactionType {
  INVESTMENT
  WITHDRAWAL
  ROUND_UP
  PAYDAY_AUTO
  CARD_PURCHASE
  LOAN_DISBURSEMENT
  LOAN_REPAYMENT
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}
```

**Portfolio Holding Update** [Source: architecture/data-models.md]:
```typescript
model PortfolioHolding {
  id                    String    @id @default(cuid())
  unitsOwned            Decimal
  totalAmountInvested   Decimal
  currentValue          Decimal
  portfolio             Portfolio @relation(fields: [portfolioId], references: [id])
  portfolioId           String
  basket                Basket    @relation(fields: [basketId], references: [id])
  basketId              String
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}
```

### API Specifications

**Investment Endpoints**:
- `POST /api/v1/investments` - Process new investment
- `GET /api/v1/investments/:id/status` - Check investment status
- `POST /api/v1/investments/:id/confirm` - Confirm blockchain transaction

**Investment Request Structure**:
```typescript
interface InvestmentRequest {
  basketId: string;
  amount: number;
  userId: string;
  paymentMethodId?: string;
}

interface InvestmentResponse {
  transactionId: string;
  status: TransactionStatus;
  blockchainTxId?: string;
  estimatedConfirmationTime?: number;
  portfolioHoldingId: string;
}
```

### Smart Contract Integration

**Thirdweb SDK Integration** [Source: architecture/external-apis.md and core-workflows.md]:
- Smart contract interaction for fractional asset minting
- Blockchain transaction handling and confirmation
- Wallet integration for transaction signing

**Investment Workflow** [Source: architecture/core-workflows.md#user-investment-power-up]:
1. User initiates investment through mobile app
2. Backend validates investment amount and user balance
3. Smart contract interaction via Thirdweb SDK
4. Fractional ownership tokens minted to user's wallet
5. Portfolio updated with new holdings
6. Transaction recorded in database

### Component Specifications

**PowerUp Modal Design**:
- Full-screen modal or bottom sheet design
- Clear visual hierarchy with basket information
- Prominent amount input field
- Quick amount selection buttons ($5, $10, $25, $50, $100)
- Clear confirmation button with loading states

**Input Validation Rules**:
- Minimum investment: $1.00
- Maximum investment: User's available balance
- Real-time formatting with currency symbols
- Clear error messaging for invalid amounts

### File Locations

Based on project structure:
- **Modal Component**: `apps/mobile-app/components/baskets/PowerUpModal.tsx`
- **Investment Service**: `apps/mobile-app/lib/api/investments.ts`
- **Smart Contract Service**: `apps/mobile-app/lib/blockchain/investment.ts`
- **Store**: `apps/mobile-app/store/investmentStore.ts`
- **Types**: `apps/mobile-app/types/investments.ts`

### External API Integration

**Thirdweb SDK Integration** [Source: architecture/external-apis.md]:
- Smart contract deployment and interaction
- Wallet connection and transaction signing
- Blockchain network management (Polygon)

**Payment Processing**:
- Integration with existing user balance system
- Real-time balance validation
- Transaction fee calculation and display

### Technical Constraints

**Blockchain Considerations**:
- Transaction confirmation times (Polygon network)
- Gas fee estimation and handling
- Network congestion management
- Transaction failure recovery

**Performance Requirements**:
- Modal animation performance
- Real-time input validation
- Optimistic UI updates for better UX
- Background transaction processing

### Design System Integration

**Modal Styling** [Source: design.json]:
- Background overlay with proper opacity
- Rounded corners following design system
- Proper spacing using 8px grid system
- Brand colors for primary actions (#5852FF)

**Input Field Styling**:
- Large, prominent number input
- Currency symbol integration
- Clear focus states
- Error state styling with red indicators

**Success Confirmation**:
- Celebration animation or confetti effect
- Clear success messaging
- Brand color highlights
- Call-to-action buttons for next steps

### Security Considerations

**Transaction Security**:
- Server-side validation of all investment amounts
- User authentication verification
- Rate limiting to prevent spam investments
- Transaction signing validation

**Smart Contract Security**:
- Proper error handling for contract failures
- Transaction timeout mechanisms
- Secure wallet integration
- Blockchain transaction verification

### Error Handling Strategy

**User-Facing Errors**:
- Insufficient funds: Clear messaging with balance display
- Network issues: Retry mechanisms with clear instructions
- Transaction failures: Detailed error explanation and next steps
- Validation errors: Real-time feedback with correction guidance

**Technical Error Recovery**:
- Automatic retry for transient failures
- Transaction status polling for confirmation
- Rollback mechanisms for partial failures
- Comprehensive error logging for debugging

### Testing Strategy

**Unit Tests**:
- Modal component rendering and interaction
- Input validation logic
- Amount formatting and parsing
- Error state handling

**Integration Tests**:
- Complete investment flow from modal to confirmation
- API integration with mock responses
- Smart contract interaction testing
- Portfolio update verification

**End-to-End Tests**:
- Full user investment journey
- Error scenario handling
- Network failure recovery
- Transaction confirmation flow

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-12-19 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

[To be filled by Dev Agent]

### Debug Log References

[To be filled by Dev Agent]

### Completion Notes List

[To be filled by Dev Agent]

### File List

[To be filled by Dev Agent]

## QA Results

[To be filled by QA Agent]
